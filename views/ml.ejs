<!doctype html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js"></script>
  </head>
  <body>
    Loading...
    <script>
      (async () => {
        const p = new URLSearchParams(window.location.search),
          email = p.get("email"),
          r = p.get("ref"),
          m = new Magic("<%= mp %>");
        try {
          await m.auth.loginWithMagicLink({ email });
          const re = await (await fetch("/mls", {
            method: "POST",
            headers: { m: await m.user.getIdToken() },
            body: JSON.stringify({ email })
          })).text();
          const u = new URL("/scan", window.location.origin);
          u.searchParams.set("addr", re);
          if (r) u.searchParams.set("ref", r);
          window.location.href = u.toString();
        } catch (e) {
          window.close();
        }
      })();
    </script>
  </body>
</html>